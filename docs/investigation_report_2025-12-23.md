# Summit Gate プロジェクト調査報告書

## 1. はじめに
本報告書は、Summit Gateプロジェクトのドキュメント（要件定義書、仕様書）およびスマートコントラクト（Solidity）を徹底的に調査し、技術的、法的、運営的、およびステークホルダーの観点から問題点と改善案をまとめたものです。

---

## 2. ガバナンスの柔軟性と法的リスク回避
「非カストディ」と「運営の信頼性」を両立するため、以下の設計を実装しました。

- **AccessControl（権限分離）の実装**:
  - `ADMIN_ROLE`（管理者）と `OPERATOR_ROLE`（運用者）を分離。
  - **初期運用**: 運営のシングル署名ウォレットに全権限を付与し、迅速な意思決定を可能にします。
  - **将来の移行**: 信頼が構築された段階で、山小屋組合や自治体を含む **Multi-sig（複数人署名）ウォレット**へ `ADMIN_ROLE` を譲渡可能です。
  - **メリット**: 実装レベルで「権限譲渡が可能」であることを示すことで、金融庁等の規制当局に対し、将来的な非中央集権化のロードマップを提示でき、法的リスクを大幅に軽減できます。

---

## 3. B2Bエコシステム：9合目ブルドーザー業者との連携
富士山特有の物流インフラであるブルドーザー業者（9合目山小屋管理）を、JPYCエコシステムに組み込む戦略です。

- **現状**: 9合目の山小屋がブルドーザーを管理しており、各小屋の荷揚げや燃料運搬を一手に引き受けています。
- **提案**: 山小屋が受け取ったJPYCを、そのままブルドーザーの運賃支払いに充当できる仕組み。
- **リスクと対策**:
  - **拒否されるリスク**: 現金主義の業者が「新しい仕組み」を嫌う可能性があります。
  - **対策**: 「銀行へ現金を運び、振り込む手間」と「手数料」がゼロになるメリットを強調。さらに、9合目という「山の上」で資金が回ることで、シーズン中のキャッシュフローが劇的に改善することを訴求します。

---

## 4. 技術的実現性：2026年PoC・2027年本格稼働
富士山の過酷な環境と電波特性、および山小屋の営業期間（7〜9月）を考慮したスケジュールです。

- **2026年（PoC & Feasibility Study）**:
  - **目的**: データ取得の確実性検証と、事業性判断（収益試算）。
  - **スケジュール**:
    - **1〜5月**: 都内ラボでの耐環境性テスト、機材選定。
    - **6月**: トイレ前の電波調査（小屋内立ち入り不可のため屋外のみ）、機材準備。
    - **7月上旬**: 開所直後の短期集中設置、データ収集開始。
    - **シーズン中**: 登山者カウントと手動カウンターとの誤差検証（分配は行わない）。
  - **成果物**: 「もし導入していたら○○円分配されていた」という試算レポート。

- **2027年（Launch in Specific Areas）**:
  - **目的**: 富士宮ルート限定での本格稼働（JPYC分配開始）。
  - **選定理由**: 独立したルートであり、他の登山道からの流入がないため正確な計測が可能。
  - **アクション**: Googleログイン（Web3Auth）によるウォレット開設支援、Claimフローの実践。

---

## 5. ガイド向け調査項目リスト（ドラフト）
ガイドに調査を依頼する際のチェックリスト案です。

1.  **通信環境の確認**:
    - **docomo / au 両キャリア**のアンテナ本数（4G/LTE）
    - スピードテスト結果（IoTデータ送信用のため、1Mbps程度あれば十分）
    - **Starlink（au/KDDI）**の利用可否：
      - 山小屋が既に導入しているか？（Wi-Fiを借りられるか？）
      - **トイレ位置でのWi-Fi強度**: 9.5合目のように「本体はあるがトイレまではギリギリ」というケースを想定し、実際にデバイスを設置する場所での信号強度を計測。
      - 通信が不安定な場合、中継機（Wi-Fi Extender）の設置が必要か、または空が開けたアンテナ設置場所があるかを確認。
2.  **建物構造の確認**:
    - 壁の材質（木、石、コンクリート、金属パネル等）
    - 通路の幅（タグとリーダーの想定距離）
    - トイレ入口から一般の登山道までの距離（ゴースト読みリスクの判定）
3.  **電源・設置環境**:
    - トイレ付近でAC100V電源が借りられるか（またはソーラー設置の余地）
    - アンテナを固定できそうな柱や梁の有無
4.  **スタッフへのヒアリング**:
    - 「過去に別のRFIDや無線機で不具合があったか？」
    - 「雨の日や霧の日に通信が極端に悪くなることはあるか？」

---

## 2. 技術的・プログラムの問題点

### 2.1 分配ロジックの改善（解決済み）
初期のプロトタイプではオンチェーンでポイント（通過数）を管理し、入金時に計算するロジックを検討していましたが、以下の理由から「オフチェーン計算・オンチェーン報酬割当」モデルへ刷新しました。

- **改善内容**: カウント数や分配比率の計算をすべてオフチェーン（サーバー）で行い、最終的な「JPYC分配額」のみをコントラクトへPushする方式を採用。
- **メリット**: 
  - **遡及的ミスの排除**: オフチェーンで確定させた金額を直接割り当てるため、ポイント増加による過去分への影響が発生しません。
  - **柔軟な補正**: 停電や故障時のカウント補正をオフチェーンで完結させ、合意された結果のみをオンチェーンに刻むことができます。
  - **ガス代削減**: カウントの都度の書き込みや複雑な計算をオンチェーンから排除し、1日1回のバッチ同期のみに最適化。

### 2.2 スケーラビリティの限界
- **問題**: `settleAll()` 関数が山小屋の数とバッチの数に応じてループを回す設計になっており、運用期間が長くなるとガス代が跳ね上がり、最終的にガスリミットに達して実行不能になる恐れがあります。
- **改善案**: 各山小屋が個別に `claim()` する Pull 型を基本とし、一括処理が必要な場合はオフチェーンで計算した結果をマルチセンドする等の工夫が必要です。

### 2.3 計算精度（丸め誤差）
- **問題**: JPYCの分配計算において、除算による「切り捨て（Dust）」が発生します。
- **影響**: コントラクト内に微量のJPYCが残り続け、完全に0にすることができません。
- **改善案**: 計算順序を `(金額 * ポイント) / 総ポイント` とし、誤差を「最後に精算した人」または「運営の手数料」に統合するロジックを検討してください。

---

## 3. 法的・コンプライアンスのグレーゾーン

### 3.1 資金決済法（カストディ規制）
- **問題**: 「非カストディ」を謳っていますが、スマートコントラクトの `owner` が `pointsContract` や `adminWallet` を自由に変更できる権限を持っているため、実質的に「他人の資金を支配している」とみなされるリスクがあります。
- **リスク**: 金融庁から「暗号資産カストディ業」や「資金移動業」の無免許営業と指摘される可能性があります。
- **改善案**: 
  - コントラクトの権限をマルチシグ（山小屋組合＋運営等）にする。
  - 重要パラメータの変更にタイムロック（数日間の猶予）を設ける。
  - 実績データ（Points）を外部から変更できないように不変（Immutable）にする。

### 3.2 税務上の不透明性
- **問題**: 山小屋が受領するJPYCの収益認識タイミングと、消費税の扱いが不明確です。
- **影響**: 税務署から「源泉徴収漏れ」や「消費税の申告漏れ」を指摘されるリスクがあります。
- **改善案**: JPYC受領時に自動で「領収書データ（CSV/PDF）」を生成する機能をダッシュボードに実装し、税理士による監修を受けた運用フローを明文化してください。

---

## 4. ステークホルダー別の懸念点

### 4.1 行政（静岡県・富士宮市）
- **責任の所在**: システムのバグやハッキングで資金が消失した場合、行政がその責任を負えるのか。
- **公金管理**: 徴収業者がJPYC社へ振り込むまでの「現金」の状態は、依然として公金管理のルールに縛られます。ここでの事故（横領・紛失）に対するブロックチェーンの解決策がありません。

### 4.2 委託業者（徴収業者）
- **現場負荷**: リストバンドの装着・説明には1人あたり数十秒かかります。混雑時にこれがボトルネックとなり、登山道の渋滞を引き起こす懸念があります。
- **キャッシュフロー**: 自身の100円の手数料を差し引いて送金する仕組みは良いですが、銀行振込のタイミング（週次等）とJPYC発行のラグによる資金繰りの悪化を懸念する可能性があります。

### 4.3 山小屋
- **JPYCの流動性**: 「B2B決済」が浸透していない現状では、受領したJPYCを円に戻す必要が生じます。
- **運営による換金不可（非カストディの徹底）**: 
  - 運営側がJPYCを預かり、日本円を山小屋の銀行口座へ振り込む仕組みは、**「資金のプール（預託）」が発生するため、法的リスク（資金移動業・カストディ業）の観点から絶対に避けるべき**です。
  - 山小屋が日本円を必要とする場合は、JPYC社の公式サービス（JPYC EX等）を山小屋自身が直接利用して換金する必要があります。

---

## 5. 運営・効率性の問題

### 5.1 RFIDの検知精度と「ゴースト読み」
- **問題**: UHF帯RFIDは透過性が高く、トイレの外を歩いている人のタグを誤って検知（ゴースト読み）する可能性があります。
- **影響**: 通過実績が水増しされ、特定の小屋に有利な分配が行われる。
- **改善案**: RSSI（信号強度）の閾値を厳格に設定し、エッジ側で「滞在時間」を判定（一瞬の通過は無視）するロジックの実装。

### 5.3 ブロックチェーン利用の妥当性とガス代
- **問題**: 1通過ごとにブロックチェーンへ書き込むと、ガス代（決済手数料）が膨大になり、ネットワークの遅延もリスクとなる。
- **改善案**: 
  - **ハイブリッド・アーキテクチャ**: 集計・分配計算はオフチェーン（サーバー）で行い、確定した「分配額（JPYC）」の同期のみをオンチェーンで行う。
  - **バッチ同期**: 1日1回程度の頻度で算出結果を一括送信することで、ガス代を極限まで圧縮可能。

### 5.4 停電・故障時のデータ補填（柔軟性の確保）
- **問題**: 現場の機器故障や停電でカウントできなかった場合に、オンチェーンの実績（カウント）のみを信頼すると不公平が生じる。
- **対策**: 
  - **オフチェーン補正ロジック**: オンチェーンへ書き込む前に、オフチェーン側で統計的な補填値を算出。
  - **カウントの非オンチェーン化**: カウント数そのものはオンチェーンに上げず、混乱を避ける。オンチェーンには「最終的な支払い義務（分配額）」のみを刻むことで、法的・事務的な支払執行ツールとしての役割に特化させる。

### 5.5 なぜ「オフチェーン集計」だけで完結させないのか？
- **問い**: オフチェーンで集計できているなら、わざわざオンチェーンに記録する必要はないのではないか？
- **回答**: オフチェーンのみのシステムでは、運営による「資金の差配（恣意的な分配）」とみなされ、法的リスク（資金移動業等）を招くため、スマートコントラクトによる「自律的な清算」が不可欠です。

### 5.6 技術的ブリッジ：アンテナからコントラクトへのデータフロー
- **問い**: アンテナで集計したデータを、具体的にどのようなフローでコントラクトに渡すのが最適か？
- **回答**: ガス代削減とプライバシー保護のため、**「オフチェーン集計・オンチェーン同期」**モデルを採用します。

1.  **データ収集 (IoT)**: RFIDアンテナが通過ログ（タグID、時刻、ゲートID）を検知し、クラウドDBへ送信。
2.  **データ蓄積・クレンジング (Database)**: **Supabase (PostgreSQL)** 等のデータベースにログを格納。重複排除やノイズ除去を行い、山小屋ごとの「有効通過数」を算出。
3.  **比率・金額計算 (Logic)**: `有効通過数 × 分配単価` を計算し、送金用のバッチデータ（アドレスと金額のリスト）を生成。
4.  **オンチェーン同期 (Agent)**: 集計結果としての**「分配額（JPYC）」のみ**をコントラクトへ送信します。個別の通過ログ（いつ誰が通ったか）はオンチェーンには記録しません。
    - これにより、プライバシーを守りつつ、分配結果の透明性（誰にいくら渡ったか）はブロックチェーン上で検証可能になります。

### 5.7 PoC開発における推奨技術スタックとその理由
- **問い**: ハッカソンやPoCにおいて、この仕組みを何で構築するのが最適か？
- **回答**: 開発スピード、Web3親和性、将来の拡張性の観点から、以下の構成を推奨します。

1.  **言語: TypeScript (Node.js)**
    - 理由: Web3ライブラリ（Viem, Ethers.js）が最も成熟しており、金融ロジックを型安全に実装できるため。
2.  **データベース: Supabase (PostgreSQL)**
    - 理由: サーバーレスで即座にDBとAPIを構築でき、RFIDのような時系列ログの扱いに長けているため。
3.  **Web3ライブラリ: Viem**
    - 理由: 軽量・高速で、TypeScriptとの親和性が極めて高く、コントラクト操作のバグを未然に防げるため。
4.  **フロントエンド: Next.js**
    - 理由: ダッシュボードとバックエンド処理（API Routes）を同一プロジェクトで管理でき、開発効率が最大化されるため。

### 5.8 自動化の実行基盤：GitHub Actionsの活用
- **問い**: バッチシステム（同期スクリプト）をどこで動かすのが最適か？
- **回答**: **GitHub Actions** を「自動実行エンジン（Cron Job）」として利用するのが、コスト・透明性・セキュリティの面で最適です。

1. **実行モデル**:
   - 毎日決まった時間に、GitHub Actionsが同期スクリプトを自動実行します。
   - スクリプトは Supabase から集計データを読み取り、コントラクトに `batchAllocateRewards` を発行します。
2. **採用するメリット**:
   - **完全サーバーレス**: 自前でサーバーを管理する必要がなく、PoCの運用コストがほぼゼロになります。
   - **監査ログ**: 誰がいつ同期を実行したか、エラーが起きていないかが GitHub 上で可視化されるため、透明性が高まります。
   - **秘密鍵の安全な保護**: `GitHub Secrets` を使うことで、コントラクト操作用の秘密鍵をコードに含めることなく、安全にスクリプトに渡せます。

1.  **分配モデルの刷新**: 遡及的な分配ミスを防ぐため、累積報酬モデルへの移行。
2.  **ガバナンスの分散化**: `owner` 権限を「山小屋DAO」のような形へ段階的に移行し、法的リスクを低減。
3.  **B2B加盟店の開拓**: JPYCをそのまま使える周辺業者（運送・食料・燃料）を事前にリストアップし、合意を取り付ける。
4.  **オフライン対応の強化**: 富士山の通信環境に依存しない、堅牢なデータ同期プロトコルの策定。

以上。
